// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
}

// Modelo para conte√∫do CMS
model Content {
  id        Int      @id @default(autoincrement())
  page      String // 'home', 'about', 'services', etc.
  section   String // 'hero', 'welcome', 'services', etc.
  key       String // identificador √∫nico do conte√∫do
  type      String // 'text', 'title', 'description', 'image'
  value     String   @db.Text
  metadata  Json? // informa√ß√µes extras como alt text para imagens
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([page, section, key])
}

// Modelo para uploads de imagens
model Upload {
  id           Int      @id @default(autoincrement())
  filename     String
  originalName String
  path         String
  mimeType     String
  size         Int
  width        Int?
  height       Int?
  alt          String?
  category     String? // 'profile', 'service', 'gallery', etc.
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Modelo para analytics
model Analytics {
  id        Int      @id @default(autoincrement())
  event     String // 'page_view', 'section_view', 'appointment_created', etc.
  page      String?
  section   String?
  metadata  Json? // dados adicionais como user agent, referrer, etc.
  sessionId String?
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())
}

// Modelo para agendamentos (para relat√≥rios)
model Appointment {
  id                 Int      @id @default(autoincrement())
  nome               String
  email              String
  telefone           String
  dataSelecionada    DateTime
  horarioSelecionado String
  modalidade         String
  endereco           String?  // Endere√ßo selecionado (apenas para presencial)
  primeiraConsulta   Boolean  @default(false)
  mensagem           String?
  codigo             String   @unique
  status             String   @default("agendado") // agendado, confirmado, cancelado, realizado
  googleEventId      String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // üîí CONSTRAINT: Impede agendamentos duplicados no mesmo hor√°rio
  // Ignora agendamentos cancelados para permitir reagendamento
  @@unique([dataSelecionada, horarioSelecionado], name: "unique_datetime_slot")
  @@index([dataSelecionada, horarioSelecionado, status], name: "idx_appointment_datetime_status")
}

// Modelo para configura√ß√µes do sistema
model Settings {
  id        Int      @id @default(autoincrement())
  key       String   @unique // identificador √∫nico da configura√ß√£o
  value     String   @db.Text // valor da configura√ß√£o (JSON)
  section   String // se√ß√£o da configura√ß√£o (geral, agendamento, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Modelo para p√°ginas din√¢micas gen√©ricas
model DynamicPage {
  id          Int      @id @default(autoincrement())
  slug        String   @unique // URL da p√°gina (ex: "politica-privacidade")
  title       String              // T√≠tulo da p√°gina
  bannerImage String?             // Imagem do banner (opcional)
  content     String   @db.Text   // Conte√∫do HTML/Markdown
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
}

// Enum para tipos de bloqueio de hor√°rios
enum BlockType {
  RECURRING  // Bloqueio recorrente semanal (ex: todas segundas √†s 9h)
  ONE_TIME   // Bloqueio pontual em data espec√≠fica (ex: 25/12/2025 √†s 10h)
}

// Modelo para bloqueio de hor√°rios espec√≠ficos
model BlockedSlot {
  id           String    @id @default(cuid())

  // Para bloqueios RECORRENTES (ex: todas as segundas √†s 9h)
  dayOfWeek    Int?      // 1=Segunda, 2=Ter√ßa, ..., 7=Domingo (padr√£o ISO)
  timeSlot     String    // ex: "09:00"

  // Para bloqueios PONTUAIS (ex: 23/11/2025 √†s 11h)
  specificDate DateTime? // Data espec√≠fica (ignora dayOfWeek se preenchido)

  // Tipo e metadados
  blockType    BlockType // RECURRING ou ONE_TIME
  reason       String?   // Motivo opcional (ex: "Reuni√£o mensal", "Feriado")
  isActive     Boolean   @default(true) // Permite desativar sem deletar

  // Auditoria
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  createdBy    String    // Nome ou ID do admin que criou

  // √çndices para performance (queries r√°pidas)
  @@index([dayOfWeek, timeSlot, isActive])
  @@index([specificDate, timeSlot, isActive])
}
